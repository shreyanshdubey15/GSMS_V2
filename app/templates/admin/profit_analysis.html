{% extends "admin/base_admin.html" %}

{% block admin_content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">Profit Analysis</h1>
        <p class="text-muted">Financial performance and profitability insights</p>
    </div>
</div>

<!-- Profit Overview Cards -->
<div class="row mb-4">
    {% for period, data in profit_data.items() %}
        <div class="col-md-3 mb-3">
            <div class="card {% if data.profit > 0 %}bg-success{% else %}bg-danger{% endif %} text-white">
                <div class="card-body">
                    <h6 class="card-title">{{ period.replace('_', ' ').title() }}</h6>
                    <h4 class="mb-1">${{ "%.2f"|format(data.profit) }}</h4>
                    <small>
                        Revenue: ${{ "%.2f"|format(data.revenue) }}<br>
                        Margin: {{ "%.1f"|format(data.margin) }}%<br>
                        Orders: {{ data.orders }}
                    </small>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Profit Trend Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Profit Trend (Last 30 Days)</h5>
            </div>
            <div class="card-body">
                <canvas id="profitTrendChart" width="400" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top Profitable Products -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Top Profitable Products (30 Days)</h5>
            </div>
            <div class="card-body p-0">
                {% if top_profitable_products %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Units Sold</th>
                                    <th>Total Revenue</th>
                                    <th>Cost Estimate</th>
                                    <th>Profit</th>
                                    <th>Margin</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in top_profitable_products %}
                                    {% set cost = product.total_revenue * (cost_margin / 100) %}
                                    {% set profit = product.total_profit %}
                                    {% set margin = (profit / product.total_revenue * 100) if product.total_revenue > 0 else 0 %}
                                    <tr>
                                        <td><strong>{{ product.name }}</strong></td>
                                        <td>{{ product.total_sold }}</td>
                                        <td>${{ "%.2f"|format(product.total_revenue) }}</td>
                                        <td>${{ "%.2f"|format(cost) }}</td>
                                        <td class="{% if profit > 0 %}text-success{% else %}text-danger{% endif %}">
                                            <strong>${{ "%.2f"|format(profit) }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge {% if margin > 20 %}bg-success{% elif margin > 10 %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ "%.1f"|format(margin) }}%
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <p>No profit data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Cost Configuration -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Cost Configuration</h5>
            </div>
            <div class="card-body">
                <form id="costConfigForm">
                    <div class="mb-3">
                        <label for="costMargin" class="form-label">Cost Margin (%)</label>
                        <input type="number" class="form-control" id="costMargin" value="{{ cost_margin }}" step="0.1" min="0" max="100">
                        <div class="form-text">Percentage of selling price that represents cost</div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update Cost Margin</button>
                </form>

                <hr class="my-3">

                <div class="text-center">
                    <h6>Current Settings</h6>
                    <p class="mb-1">Cost Margin: <strong>{{ "%.1f"|format(cost_margin) }}%</strong></p>
                    <p class="mb-1">Profit Margin: <strong>{{ "%.1f"|format(100 - cost_margin) }}%</strong></p>
                    <small class="text-muted">Based on 30-day average</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Financial Insights -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Financial Insights & Recommendations</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success mb-3">üí∞ Profit Opportunities</h6>
                        <ul class="list-unstyled">
                            {% set top_profitable = top_profitable_products[:3] %}
                            {% if top_profitable %}
                                {% for product in top_profitable %}
                                    <li class="mb-2">
                                        <i class="fas fa-arrow-up text-success me-2"></i>
                                        <strong>{{ product.name }}</strong> generating ${{ "%.2f"|format(product.total_profit) }} profit
                                    </li>
                                {% endfor %}
                            {% endif %}
                            <li class="mb-2">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                Consider increasing prices on high-margin items by 5-10%
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-users text-info me-2"></i>
                                Focus marketing on top 20% products generating 80% of profits
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">‚ö†Ô∏è Cost Management</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                Monitor products with profit margins below 15%
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-truck text-info me-2"></i>
                                Negotiate better supplier terms for high-volume items
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-chart-bar text-primary me-2"></i>
                                Review inventory turnover rates monthly
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-tags text-success me-2"></i>
                                Implement dynamic pricing for seasonal items
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profitability Analysis -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Profitability Analysis</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center p-3">
                            <h4 class="text-success">${{ "%.2f"|format(profit_data.last_30_days.profit) }}</h4>
                            <p class="mb-1">30-Day Profit</p>
                            <small class="text-muted">{{ "%.1f"|format(profit_data.last_30_days.margin) }}% margin</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3">
                            <h4 class="text-primary">${{ "%.2f"|format(profit_data.last_30_days.revenue / profit_data.last_30_days.orders if profit_data.last_30_days.orders > 0 else 0) }}</h4>
                            <p class="mb-1">Avg Order Value</p>
                            <small class="text-muted">Revenue per transaction</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3">
                            <h4 class="text-info">{{ profit_data.last_30_days.orders }}</h4>
                            <p class="mb-1">Total Orders</p>
                            <small class="text-muted">Last 30 days</small>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="row">
                    <div class="col-md-6">
                        <h6>Break-even Analysis</h6>
                        <div class="mb-3">
                            <label class="form-label">Fixed Costs ($/month)</label>
                            <input type="number" class="form-control" id="fixedCosts" value="5000" step="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Variable Cost per Order ($)</label>
                            <input type="number" class="form-control" id="variableCost" value="2.50" step="0.10">
                        </div>
                        <button class="btn btn-outline-primary" onclick="calculateBreakEven()">
                            Calculate Break-even Point
                        </button>
                        <div id="breakEvenResult" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <h6>Break-even Results:</h6>
                                <p id="breakEvenOrders"></p>
                                <p id="breakEvenRevenue"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Profit Forecasting</h6>
                        <div class="mb-3">
                            <label class="form-label">Expected Monthly Orders</label>
                            <input type="number" class="form-control" id="forecastOrders" value="{{ profit_data.last_30_days.orders }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Expected Avg Order Value ($)</label>
                            <input type="number" class="form-control" id="forecastValue" value="{{ "%.2f"|format(profit_data.last_30_days.revenue / profit_data.last_30_days.orders if profit_data.last_30_days.orders > 0 else 0) }}" step="0.01">
                        </div>
                        <button class="btn btn-outline-success" onclick="forecastProfit()">
                            Forecast Monthly Profit
                        </button>
                        <div id="forecastResult" class="mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <h6>Profit Forecast:</h6>
                                <p id="forecastProfit"></p>
                                <p id="forecastRevenue"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Profit Trend Chart
    const profitData = {{ profit_trend|tojson }};
    const ctx = document.getElementById('profitTrendChart').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: profitData.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }),
            datasets: [{
                label: 'Daily Profit ($)',
                data: profitData.map(item => item.profit),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Profit Trend Over Time'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
});

function calculateBreakEven() {
    const fixedCosts = parseFloat(document.getElementById('fixedCosts').value);
    const variableCost = parseFloat(document.getElementById('variableCost').value);
    const avgOrderValue = {{ "%.2f"|format(profit_data.last_30_days.revenue / profit_data.last_30_days.orders if profit_data.last_30_days.orders > 0 else 0) }};

    const contributionMargin = avgOrderValue - variableCost;
    const breakEvenOrders = Math.ceil(fixedCosts / contributionMargin);
    const breakEvenRevenue = breakEvenOrders * avgOrderValue;

    document.getElementById('breakEvenOrders').textContent = `Break-even Orders: ${breakEvenOrders}`;
    document.getElementById('breakEvenRevenue').textContent = `Break-even Revenue: $${breakEvenRevenue.toFixed(2)}`;
    document.getElementById('breakEvenResult').style.display = 'block';
}

function forecastProfit() {
    const orders = parseInt(document.getElementById('forecastOrders').value);
    const avgValue = parseFloat(document.getElementById('forecastValue').value);
    const costMargin = {{ cost_margin / 100 }};

    const revenue = orders * avgValue;
    const cost = revenue * costMargin;
    const profit = revenue - cost;

    document.getElementById('forecastRevenue').textContent = `Expected Revenue: $${revenue.toFixed(2)}`;
    document.getElementById('forecastProfit').textContent = `Expected Profit: $${profit.toFixed(2)} (${((profit/revenue)*100).toFixed(1)}% margin)`;
    document.getElementById('forecastResult').style.display = 'block';
}

document.getElementById('costConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const costMargin = document.getElementById('costMargin').value;

    // In a real app, this would send to server
    alert(`Cost margin updated to ${costMargin}%. Page will refresh to show new calculations.`);
    location.reload();
});
</script>
{% endblock %}